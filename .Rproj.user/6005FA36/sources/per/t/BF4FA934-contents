---
title: "INE"
format: html
editor: visual
---

## Quarto

Quarto enables you to weave together content and executable code into a finished document. To learn more about Quarto see <https://quarto.org>.

```{r}
install.packages('jsonlite', dependencies=TRUE, repos='http://cran.rstudio.com/')
# SOURCE: https://cedricscherer.netlify.app/2019/05/17/the-evolution-of-a-ggplot-ep
# Packages
library(jsonlite)

install.packages("tidyverse", dependencies=TRUE, repos='http://cran.rstudio.com/')
library(tidyverse)

required_packages <- c(#"tidyverse",
                       "ggthemes",
                       "xlsx",
                       "tsbox",
                       "tseries",
                       "xts",
                       "forecast",
                       "showtext",
                       "scales"
                       )
#ploty
for (pkg in required_packages) {
  # install packages if not already present
  if (!pkg %in% rownames(installed.packages())) {
    install.packages(pkg)
  }

  # load packages to this current session
  library(pkg, character.only = TRUE)


}

remove(pkg)
```

## Fetch Datasets

```{r}
library(readxl)
Indicadores <- read_excel("datasets/Indicadores.xlsx", skip = 14)

Indicadores <- Indicadores %>%
  filter(`Disponível no Portal`== "Sim")
```

```{r}

# https://www.ine.pt/ine/json_indicador/pindica.jsp?op=2&varcd=0011613&Dim1=T&lang=PT
numbers <- Indicadores$`Código de difusão`
l <- length(numbers)

for(i in 1:l ){
  # assign(numbers[i],fromJSON(paste0("https://www.ine.pt/ine/json_indicador/pindica.jsp?op=2&varcd=",numbers[i],"&Dim1=T&lang=PT")))
    result <- fromJSON(paste0("https://www.ine.pt/ine/json_indicador/pindica.jsp?op=2&varcd=",numbers[i],"&Dim1=T&lang=PT"))
  if (!("IndicadorCod" %in% colnames(result))) {
    numbers <- numbers[-i]
    l <- l - 1
    i <- i - 1
  } else {
    assign(result$IndicadorDsg,as.data.frame(result$Dados))
    d2 <- unnest_longer(result$Dados,col = colnames(result$IndicadorDsg),names_repair = "minimal")
    write_csv(d2,file = paste0("datasets/",numbers[i],".csv"))
  }
   if (i %% 100 == 0) {
      Sys.sleep(60)
  }
}


pop<-fromJSON("https://www.ine.pt/ine/json_indicador/pindica.jsp?op=2&varcd=0011626&Dim1=T&Dim2=0101&lang=PT", flatten = TRUE)
pop<-as.data.frame(pop$Dados.2021)
pop
# https://www.ine.pt/ine/json_indicador/pindica.jsp?op=2&varcd=0011626&Dim1=T&Dim2=200&lang=PT
```

## Getting datasets from base

```{r}
codigos_df <- read_excel("datasets/ref_geo.xlsx")
numbers <- codigos_df$last4
l <- length(numbers)
for(i in 1:l ){
    result<- fromJSON(paste0("https://www.ine.pt/ine/json_indicador/pindica.jsp?op=2&varcd=0011626&Dim1=T&Dim2=",numbers[i],"&lang=PT"))
    pop <- as.data.frame(result$Dados$'2021')
   if (i %% 10 == 0) {
      Sys.sleep(60)
   }
  if(i==1){
  d2 <- pop
  }else{
    d2 <- rbind(d2,pop)
  }
}
write_csv(d2,file = paste0("datasets/pop_base_2021.csv"))

```

## Data Cleanup

Pivot Individual

```{r}

d3 <- d2%>%
  select(-dim_3,-dim_4)%>%
  pivot_wider(names_from = dim_4_t,values_from = valor)

write_csv(d3,file = paste0("datasets/pop_base_2021_anos.csv"))
```

Pivot quinquenal

```{r}
d2$dim_4 <- as.numeric(d2$dim_4)

d3 <- 

  write_csv(d3,file = paste0("datasets/pop_base_2021_anos.csv"))
```
