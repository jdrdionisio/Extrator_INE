"0","setwd(""C:/Users/jdrdionisio/Desktop/RProjects/Projects/INE/INE_API/"")"
"2","Warning: The working directory was changed to C:/Users/jdrdionisio/Desktop/RProjects/Projects/INE/INE_API inside a notebook chunk. The working directory will be reset when the chunk is finished running. Use the knitr root.dir option in the setup chunk to change the working directory for notebook chunks."
"0","geolinkage_path <- ""datasets/geolinkage_aces_2022.csv"""
"0","geolinkage_aces <- read_csv(geolinkage_path,col_types = cols(.default = ""c""))"
"0","colnames(geolinkage_aces) "
"1"," [1]"
"1"," ""freguesia_2013""    "
"1"," ""dicofre_2013""      "
"1"," ""municipio_2013""    "
"1"," ""municipio_2013_cod"""
"1"," ""municipio_2002_cod"""
"1"," ""distrito_2013""     "
"1"," ""distrito_2013_cod"" "
"1"," ""nuts3_2013""        "
"1","
"
"1"," [9]"
"1"," ""nuts3_2013_cod""    "
"1"," ""nuts3_2002_cod""    "
"1"," ""nuts2_2013""        "
"1"," ""nuts2_2013_cod""    "
"1"," ""nuts1_2013""        "
"1"," ""nuts1_2013_cod""    "
"1"," ""pais""              "
"1"," ""pais_cod""          "
"1","
"
"1","[17]"
"1"," ""aces_2022""         "
"1"," ""aces_2022_cod""     "
"1"," ""ars_2022""          "
"1"," ""ars_2022_cod""      "
"1","
"
"0","# result_list <- list()"
"0","largest_area <- geolinkage_aces "
"0","obs_back <- 10"
"0","indicadores <- c(""0008711"",	0008079)"
"0","result_list <- list()"
"0","# result_list <- list()"
"0","# largest_area <- geolinkage_aces %>%"
"0","#   filter(aces_2022==""ACES Baixo Mondego"")"
"0",""
"0","sleep <- function(z){"
"0","  if (z %% 100 == 0) {"
"0","    Sys.sleep(5)"
"0","    z <- 1"
"0","  }else{"
"0","    z <- z+1"
"0","  }"
"0","  return(z)"
"0","  }"
"0",""
"0","# ine.get <- function(indicadores,largest_area,obs_back,result_list) {"
"0","  a <- length(indicadores)"
"0","  dicofre_2013 <- unique(largest_area$dicofre_2013)"
"0","  municipio_2013 <- unique(largest_area$municipio_2013_cod)"
"0","  municipio_2002 <- unique(largest_area$municipio_2002_cod)"
"0","  nuts_3_2013 <- unique(largest_area$nuts3_2013_cod)"
"0","  nuts_3_2002 <- unique(largest_area$nuts3_2002_cod)"
"0","  nuts_2_2013 <- unique(largest_area$nuts2_2013_cod)"
"0","  nuts_1 <- unique(largest_area$nuts1_2013_cod)"
"0","  counter <- 0"
"0","  #Existem 2 desagregacoes que estao hard-coded porque sao iguais entre 2013 e 2002"
"0","  testd <- c(""&Dim2=11102&lang=PT"",  #Testa a desagregação por freguesias"
"0","            ""&Dim2=16E0111&lang=PT"", #Testa a desagregação por municipio 2013"
"0","            ""&Dim2=1610111&lang=PT"", #Testa a desagregação por municipio 2002"
"0","            ""&Dim2=16E&lang=PT"",     #Testa a desagregação por NUTSIII 2013"
"0","            ""&Dim2=161&lang=PT"",     #Testa a desagregação por NUTSIII 2002"
"0","            ""&Dim2=16&lang=PT"",      #Testa a desagregação por NUTSII 2013"
"0","            ""&lang=PT""               #Testa a desagregação por NUTSI ou sem padrão "
"0","  )"
"0","  codes_list <- list(dicofre_2013,municipio_2013,municipio_2002,nuts_3_2013,nuts_3_2002,nuts_2_2013,"""")"
"0","  b_list <- list(length(dicofre_2013),length(municipio_2013),length(municipio_2002),length(nuts_3_2013),length(nuts_3_2002),length(nuts_2_2013),1)"
"0","  agreg_list <- list(""Freguesia"",""Municipio"",""Municipio"",""NUTSIII"",""NUTSIII"",""NUTSII"",""Nacional"")"
"0","  desag_v <- c(""&Dim2="",""&Dim2="",""&Dim2="",""&Dim2="",""&Dim2="",""&Dim2="","""")"
"0","  # geo_ref_df <- list(dicofre_2013,municipio_2013_cod,municipio_2002_cod,nuts3_2013_codnuts3_2002_cod,nuts2_2013_cod,nuts_1)"
"0","  geo_ref_by_v <- c(""dicofre_2013"","
"0","                    ""municipio_2013_cod"","
"0","                    ""municipio_2002_cod"","
"0","                    ""nuts3_2013_cod"","
"0","                    ""nuts3_2002_cod"","
"0","                    ""nuts2_2013_cod"","
"0","                    ""nuts1_2013_cod"")"
"0","  for (i in 1:a) {"
"0","    #COMECA POR LER O INDICADOR A RETIRAR"
"0","    indicador_atual <- indicadores[i]"
"0","    counter <- sleep(counter)"
"0","    test <- list()"
"0","    for (k in 1:length(testd)){"
"0","      counter <- sleep(counter)"
"0","      test[[k]] <- as.data.frame(fromJSON(paste0(""https://www.ine.pt/ine/json_indicador/pindica.jsp?op=2&varcd="",indicador_atual,""&Dim1=T"",testd[k])))"
"0","    }"
"0","    r <- 1"
"0","    b <- b_list[[1]]"
"0","    codes <- codes_list[[1]]"
"0","    agreg <- agreg_list[[1]]"
"0","    desag <- desag_v[1]"
"0","    # geo_ref_df <- geo_ref[[1]]"
"0","    geo_ref_by <- geo_ref_by_v[1]"
"0","    while(""Falso"" %in% colnames(test[[r]]$Sucesso)){"
"0","      r <- r + 1"
"0","      b <- b_list[[r]]"
"0","      codes <- codes_list[[r]]"
"0","      agreg <- agreg_list[[r]]"
"0","      desag <- desag_v[r]"
"0","      # geo_ref_df <- geo_ref[[r]]"
"0","      geo_ref_by <- geo_ref_by_v[r]"
"0","    }"
"0","    for (w in 1:b){"
"0","      counter <- sleep(counter)"
"0","      result <- fromJSON(paste0(""https://www.ine.pt/ine/json_indicador/pindica.jsp?op=2&varcd="",indicador_atual,""&Dim1=T"", desag, codes[w],""&lang=PT""))"
"0","      dados <- as.data.frame(result$Dados)"
"0","      colunas_nanos <- colnames(dados)"
"0","      num_colunas <- length(colunas_nanos)"
"0","      if(obs_back > num_colunas){"
"0","        x <-num_colunas"
"0","      }else{"
"0","        x <-obs_back"
"0","      }"
"0","      # Get column names for years of interest"
"0","      obs_cols <- as.character(c(colunas_nanos[(num_colunas-x+1):(num_colunas)]))"
"0","      df_all <- data.frame()"
"0","      # Loop over years"
"0","      for (obs in obs_cols) {"
"0","        # Remove all columns except current year"
"0","        df <- dados %>%"
"0","          unnest(!!sym(obs))%>%"
"0","          select(-any_of(colunas_nanos))%>%"
"0","          mutate(obs=as.character(obs))%>%"
"0","          left_join(largest_area, by=c(""geocod"" = as.character(geo_ref_by)),  multiple = ""first"" )"
"0","        # Add data frame to list"
"0","        df_all <- bind_rows(df_all, df)"
"0","        # Pause for 1 second"
"0","        Sys.sleep(1)"
"0","      }"
"0","      if(w==1){"
"0","        result_list[[indicador_atual]] <- df_all"
"0","      }"
"0","      else{"
"0","        result_list[[indicador_atual]] <- bind_rows(result_list[[indicador_atual]], df_all)"
"0","      }"
"0","      # return(result_list)"
"0","    }"
"0","  }"
"0","  # return(result_list)"
"0","# }  "
"0","result_list"
"1","$`0008711`
"
