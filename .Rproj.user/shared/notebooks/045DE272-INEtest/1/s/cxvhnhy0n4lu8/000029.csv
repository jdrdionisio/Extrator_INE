"0","linkage_geo <- read_csv(""datasets/linkage_geo.csv"")"
"0","  "
"0","linkage_geo <- linkage_geo %>%  "
"0","  select(geo, ars, nuts3, aces2, nuts1, nuts2, cod_geo_nuts2002, cod_geo)  %>%"
"0","  rename(municip=""geo"")%>%"
"0","  mutate(municip= recode(municip, ""Calheta""=""Calheta [R.A. Madeira]""))"
"0",""
"0","#indicador <- c()"
"0",""
"0","Indicadores <- read_excel(""datasets/Indicadores.xlsx"", skip = 14)"
"0",""
"0","Indicadores <- Indicadores %>%"
"0","  filter(`Disponível no Portal`== ""Sim"")"
"0",""
"0","#indicador <- Indicadores$`Código de difusão`"
"0",""
"0","indicador <- c(""0003182"")"
"0",""
"0","desag <- ""&Dim2="""
"0",""
"0","cod_2002 <-linkage_geo$cod_geo_nuts2002"
"0","cod_2002 <- cod_2002[! cod_2002 %in% c(""9999999"", ""0"")]"
"0",""
"0","cod_2014 <- linkage_geo$cod_geo"
"0","cod_2014 <- cod_2014[! cod_2014 %in% c(""9999999"", ""0"")]"
"0",""
"0","nuts_ii_cod <- c(""PT"",""11"",""16"",""17"",""18"",""19"",""20"",""30"")"
"0",""
"0","actual_year <- year(Sys.Date())"
"0",""
"0","x <- 5"
"0",""
"0","last_yearsv1 <- as.character(c((actual_year-x):(actual_year)))"
"0",""
"0","a <- length(indicador)"
"0",""
"0","b <- length(cod_2014) "
"0",""
"0","c <- length(nuts_ii_cod)"
"0"," "
"0","d <- length(last_yearsv1)"
"0",""
"0","counter <- 1"
"0",""
"0","result_list <- list()"
"0",""
"0","#Evitar overload do servidor do INE com requests Colocar sempre antes de um request"
"0","sleep <- function(counter){"
"0","  if (counter %% 100 == 0) {"
"0","    Sys.sleep(60)"
"0","  }"
"0","  counter <- counter+1"
"0","  return(counter)"
"0","} "
"0",""
"0","save_to_result_list <- function(){"
"0","  #Segundo loop baseado na desagregação maxima conseguida"
"0","    dados <- as.data.frame(result$Dados)"
"0","    colunas_nanos <- colnames(result$Dados)"
"0","    num_colunas <- length(colunas_nanos)"
"0","    last_year <- as.numeric(colunas_nanos[num_colunas])"
"0","    if(d > num_colunas){"
"0","      x <- num_colunas"
"0","    }"
"0","    last_years <- as.character(c((last_year-x):(last_year)))"
"0","    each_df <- dados %>%"
"0","      select(last_years[i])%>%"
"0","      unnest(last_years[i])"
"0","    colunas_por_ano <- colnames(each_df)"
"0","    for (i in 1:x) {"
"0","    #ver e retirar os nomes das colunas de cada ano para o select"
"0","    dados1 <- dados %>%"
"0","          unnest(last_years[i])%>%"
"0","          select(all_of(colunas_por_ano))"
"0","    result_list[[last_years[i]]] <- rbind(result_list[[last_years[i]]], dados1)"
"0","    }"
"0","}"
"0",""
"0","write_output <- function(){"
"0","  x <- length(as.data.frame(result_list))"
"0","  for (i in 1:x) {"
"0","    nomedf <- paste0(indicador_atual,""_"",last_years[i])"
"0","    assign(full_df, result_list[[last_years[i]]])%>% "
"0","      mutate(municip = case_when("
"0","      geocod==""3003101"" ~ ""Calheta [R.A. Madeira]"", "
"0","      geocod==""2004501"" ~ ""Calheta [R.A. Açores]"","
"0","      geocod==""2004201"" ~ ""Lagoa [R.A. Açores]"","
"0","      TRUE ~ as.character(geodsg)))%>%"
"0","      fwrite(file = paste0(""outputs/"",nomedf,"".csv""), bom = T)"
"0","  }"
"0","  #result_list <- list()"
"0","}"
"0",""
"0","for (i in 1:a) {"
"0","  indicador_atual <- indicador[i]"
"0","  for (i in b) {"
"0","  #retirar indicador com desagregação municipio 2014"
"0","  counter <- sleep(counter)"
"0","  result <- fromJSON(paste0(""https://www.ine.pt/ine/json_indicador/pindica.jsp?op=2&varcd="",indicador_atual,""&Dim1=T"", desag, cod_2014[i], ""&lang=PT""))"
"0","  number_results_loop <- length(c(1:b))"
"0","  #Chack if result exists - Se sim vai começar a fazer assign se não tenta fazer com agregação menor"
"0","      if (!(""IndicadorCod"" %in% colnames(result))) {"
"0","        #retirar indicador com desagregação municipio 2002"
"0","        for (i in 1:b) {"
"0","        counter <- sleep(counter)"
"0","        result <- fromJSON(paste0(""https://www.ine.pt/ine/json_indicador/pindica.jsp?op=2&varcd="",indicador_atual,""&Dim1=T"",desag, cod_2002[i], ""&lang=PT""))"
"0","        number_results_loop <- length(c(1:b))"
"0","        }"
"0","          if (!(""IndicadorCod"" %in% colnames(result))) {"
"0","            #retirar indicador com desagregação NUTSII "
"0","            for (i in 1:c) {"
"0","            counter <- sleep(counter)"
"0","            result <- fromJSON(paste0(""https://www.ine.pt/ine/json_indicador/pindica.jsp?op=2&varcd="",indicador_atual ,""&Dim1=T"",desag, nuts_ii_cod[i], ""&lang=PT""))"
"0","            number_results_loop <- length(c(1:c))"
"0","            } "
"0","                if (!(""IndicadorCod"" %in% colnames(result))) {"
"0","                  #retirar indicador sem desagragação "
"0","                  counter <- sleep(counter)"
"0","                  result <- fromJSON(paste0(""https://www.ine.pt/ine/json_indicador/pindica.jsp?op=2&varcd="",indicador_atual,""&Dim1=T&lang=PT""))"
"0","                  number_results_loop <- length(c(1:c))"
"0","          }"
"0","        }"
"0","      }"
"0","    "
"0","  #se o result tiver dados - grava para a results_list"
"0","  if(length(result)>0){"
"0","    dados <- as.data.frame(result$Dados)"
"0","    colunas_nanos <- colnames(result$Dados)"
"0","    num_colunas <- length(colunas_nanos)"
"0","    last_year <- as.numeric(colunas_nanos[num_colunas])"
"0","    if(d > num_colunas){"
"0","      x <- num_colunas"
"0","    }"
"0","    last_years <- as.character(c((last_year-x):(last_year)))"
"0","    each_df <- dados %>%"
"0","      select(last_years[i])%>%"
"0","      unnest(last_years[i])"
"0","    colunas_por_ano <- colnames(each_df)"
"0","    for (i in 1:x) {"
"0","    #ver e retirar os nomes das colunas de cada ano para o select"
"0","    dados1 <- dados %>%"
"0","          unnest(last_years[i])%>%"
"0","          select(all_of(colunas_por_ano))"
"0","    result_list[[last_years[i]]] <- rbind(result_list[[last_years[i]]], dados1)"
"0","    }"
"0","      x <- length(as.data.frame(result_list))"
"0","  for (i in 1:x) {"
"0","    nomedf <- paste0(indicador_atual,""_"",last_years[i])"
"0","    assign(full_df, result_list[[last_years[i]]])%>% "
"0","      mutate(municip = case_when("
"0","      geocod==""3003101"" ~ ""Calheta [R.A. Madeira]"", "
"0","      geocod==""2004501"" ~ ""Calheta [R.A. Açores]"","
"0","      geocod==""2004201"" ~ ""Lagoa [R.A. Açores]"","
"0","      TRUE ~ as.character(geodsg)))%>%"
"0","      fwrite(file = paste0(""outputs/"",nomedf,"".csv""), bom = T)"
"0","      }"
"0","    }"
"0","  }"
"0","}"
"0",""
"2","Error: Incomplete expression: linkage_geo <- read_csv(""datasets/linkage_geo.csv"")
  
linkage_geo <- linkage_geo %>%  
  select(geo, ars, nuts3, aces2, nuts1, nuts2, cod_geo_nuts2002, cod_geo)  %>%
  rename(municip=""geo"")%>%
  mutate(municip= recode(municip, ""Calheta""=""Calheta [R.A. Madeira]""))

#indicador <- c()

Indicadores <- read_excel(""datasets/Indicadores.xlsx"", skip = 14)

Indicadores <- Indicadores %>%
  filter(`Disponível no Portal`== ""Sim"")

#indicador <- Indicadores$`Código de difusão`

indicador <- c(""0003182"")

desag <- ""&Dim2=""

cod_2002 <-linkage_geo$cod_geo_nuts2002
cod_2002 <- cod_2002[! cod_2002 %in% c(""9999999"", ""0"")]

cod_2014 <- linkage_geo$cod_geo
cod_2014 <- cod_2014[! cod_2014 %in% c(""9999999"", ""0"")]

nuts_ii_cod <- c(""PT"",""11"",""16"",""17"",""18"",""19"",""20"",""30"")

actual_year <- year(Sys.Date())

x <- 5

last_yearsv1 <- as.character(c((actual_year-x):(actual_year)))

a <- length(indicador)

b <- length(cod_2014) 

c <- length(nuts_ii_cod)
 
d <- length(last_yearsv1
"
